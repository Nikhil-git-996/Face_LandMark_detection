<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Face and Iris Landmarks</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Arial", sans-serif;
        background: linear-gradient(to bottom, #6a11cb, #2575fc);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
      }

      header {
        width: 100%;
        text-align: center;
        padding: 20px 0;
        background: rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      header h1 {
        margin: 0;
        font-size: 24px;
      }

      #instructions {
        margin-top: 10px;
        font-size: 16px;
        opacity: 0.8;
      }

      #container {
        position: relative;
        width: 640px;
        height: 480px;
        margin: 20px auto;
        border: 2px solid white;
        border-radius: 10px;
        overflow: hidden;
        background: black;
      }

      video,
      canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      #warning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 0, 0, 0.7);
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 20px;
        z-index: 3;
      }

      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
        color: white;
        z-index: 4;
      }

      #controls {
        margin-top: 20px;
      }

      .button {
        padding: 10px 20px;
        margin: 0 10px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .button-primary {
        background: #28a745;
        color: white;
      }

      .button-primary:hover {
        background: #218838;
      }

      .button-secondary {
        background: #ffc107;
        color: white;
      }

      .button-secondary:hover {
        background: #e0a800;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Face and Iris Landmark Detection</h1>
      <p id="instructions">
        Please ensure your face is visible to the camera and look straight at
        the screen.
      </p>
    </header>

    <div id="container">
      <video id="video" autoplay muted></video>
      <canvas id="output"></canvas>
      <div id="warning-overlay"></div>
      <div id="loading">Loading...</div>
    </div>

    <div id="controls">
      <button class="button button-primary" onclick="resetWarnings()">
        Reset Alerts
      </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>
    <script>
      const VIDEO_WIDTH = 640;
      const VIDEO_HEIGHT = 480;

      let video, canvas, ctx, faceMesh;
      let warnings = [];
      let warningOverlay, loadingIndicator;

      // Initialize Camera
      async function setupCamera() {
        video = document.getElementById("video");
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        video.srcObject = stream;
        return new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play();
            resolve(video);
          };
        });
      }

      // Initialize MediaPipe FaceMesh
      function initializeFaceMesh() {
        faceMesh = new FaceMesh({
          locateFile: (file) =>
            `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
        });

        faceMesh.setOptions({
          maxNumFaces: 1,
          refineLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5,
        });

        faceMesh.onResults(onResults);
      }

      function displayWarning(message) {
        if (!warnings.includes(message)) {
          warnings.push(message);
          warningOverlay.style.display = "flex";
          warningOverlay.innerHTML = `<p>${message}</p>`;
          setTimeout(() => {
            warningOverlay.style.display = "none";
            warnings = warnings.filter((warning) => warning !== message);
          }, 3000);
        }
      }

      function resetWarnings() {
        warnings = [];
        warningOverlay.style.display = "none";
      }

      function onResults(results) {
        ctx.clearRect(0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
        const faces = results.multiFaceLandmarks;

        if (faces) {
          for (const landmarks of faces) {
            drawLandmarks(landmarks, "red");
          }
        }

        loadingIndicator.style.display = "none"; // Hide loading indicator after detection starts
      }

      function drawLandmarks(landmarks, color) {
        ctx.fillStyle = color;
        landmarks.forEach((landmark) => {
          const x = landmark.x * VIDEO_WIDTH;
          const y = landmark.y * VIDEO_HEIGHT;
          ctx.beginPath();
          ctx.arc(x, y, 2, 0, 2 * Math.PI);
          ctx.fill();
        });
      }

      async function main() {
        loadingIndicator = document.getElementById("loading");
        warningOverlay = document.getElementById("warning-overlay");

        await setupCamera();
        canvas = document.getElementById("output");
        ctx = canvas.getContext("2d");
        canvas.width = VIDEO_WIDTH;
        canvas.height = VIDEO_HEIGHT;

        initializeFaceMesh();
        detectFaces();
      }

      async function detectFaces() {
        await faceMesh.send({ image: video });
        requestAnimationFrame(detectFaces);
      }

      main();
    </script>
  </body>
</html>
